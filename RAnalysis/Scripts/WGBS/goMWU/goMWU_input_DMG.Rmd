---
title: "GO MWU input for methylation"
author: "Danielle Becker"
date: "2024-07-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r install packages}
#if ("rtracklayer" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install("rtracklayer")
#BiocManager::install("rrvgo")

library(dplyr)
library(ggplot2)
library(tidyverse)
library(rtracklayer)
library(rrvgo)
library(GO.db)
library(tidyr)
library(forcats)
library(scales)
sessionInfo() #list of packages after library-ing these packages
```


# Import the data files 
```{r, echo=FALSE}
# Load go terms from functional annotation file
annot_GO <- read.csv("RAnalysis/Output/RNA-seq/DEG/annot_GO.terms.host.csv")[-1]

# edit annot_GO to list GO terms all in one row per gene
annot_GO <- annot_GO %>%
  group_by(gene_id) %>%
  summarise(GO.ID = paste(GO.ID, collapse = ";")) %>%
  ungroup()

```

# Load in all DEGs and filtered gene count data
```{r}
# Read in Enriched vs Control DESeq2 results for expressed genes 
DMG.all <- read.csv("RAnalysis/Output/WGBS/DMGs_all.csv")

#rename x column to gene_id
colnames(DMG.all)[1] <-"gene_id" # make colnames a true column called gene_id
head(DMG.all)

#remove extra characters to match annotation 
DMG.all$gene_id <-  gsub("_gene_g","_g",DMG.all$gene_id) #sub gene_g with _g
DMG.all$gene_id <-  gsub("_gene_","_",DMG.all$gene_id) #remove extra _
DMG.all$gene_id <- gsub("-.*", "", DMG.all$gene_id) # Modify the gene_id column to remove the dash and anything after it
DMG.all$gene_id <-  gsub("Pver_split_", "Pver_",DMG.all$gene_id) #remove the extra _gene_ after split

# Load filtered methylation data set with genes that had methylation data
meth.dat <- readRDS("RAnalysis/Output/WGBS/sample_all_methylated_data_10x.Rdata") #read in info
head(DMG.all)

# Select the necessary columns
selected_df <- meth.dat %>% dplyr::select(Sample.ID, gene, meth)

# Transform to wide format
wide_df <- selected_df %>%
  group_by(gene, Sample.ID) %>%
  summarise(sum_meth = sum(meth), .groups = 'drop') %>% # Sum of meth values for each gene per Sample.ID
  pivot_wider(names_from = Sample.ID, values_from = sum_meth, names_prefix = "Sample_") %>% # Convert to wide format
  dplyr::rename(gene_id = gene) # Rename column from 'gene' to 'gene_id'

#remove extra characters to match annotation 
wide_df$gene_id <-  gsub("_gene_g","_g",wide_df$gene_id) #sub gene_g with _g
wide_df$gene_id <-  gsub("_gene_","_",wide_df$gene_id) #remove extra _
wide_df$gene_id<- gsub("-.*", "", wide_df$gene_id) # Modify the gene_id column to remove the dash and anything after it
wide_df$gene_id <-  gsub("Pver_split_", "Pver_",wide_df$gene_id) #remove the extra _gene_ after split

```

### Isolating comparisons and using fold change 

I'm going to isolate comparisons and then use fold change as input to GO MWU rather than a binary of 1 (DE) or 0 (not DE). 

Match up genes in gene list file to annotation file
```{r}
names(annot_GO)

gcount_filt2annot = match(annot_GO$gene_id, wide_df$gene_id) #match genes in gcount_filt to annot_GO

# The following is the number of probes without annotation 
sum(is.na(gcount_filt2annot))

row_nas<-which(is.na(gcount_filt2annot))

#view the genes that do not have a match in the annotation file
missing<-as.data.frame(gcount_filt2annot[row_nas])
#print(missing)
```
8,501 genes in DMG_filt do not have GO annotations because unknown is allowed to stay in go MWU analysis

Reduce annotation file to only contain genes detected in our dataset.  
```{r}
filtered_Pverr.annot <- annot_GO[annot_GO$gene_id %in% wide_df$gene_id, ]
dim(filtered_Pverr.annot)

# Change comma to semicolon 
filtered_Pverr.annot$GO.ID <- gsub(";", ";", filtered_Pverr.annot$GO.ID)

# Change remove unknowns from rows with other GO:ID classifications
filtered_Pverr.annot$GO.ID <- gsub(";unknown", "", filtered_Pverr.annot$GO.ID)
filtered_Pverr.annot$GO.ID <- gsub("unknown;", "", filtered_Pverr.annot$GO.ID)

```

The annotation file now only contains genes that were detected in our dataset that have annotation information. This is 18,938 out of the 27439 genes in our dataset. 

18,938 genes were retained in the filtered GO dataset. Write table for GO MWU analysis 
```{r}
write.table(filtered_Pverr.annot, "RAnalysis/Scripts/WGBS/goMWU/gene_to_go_DB_DMG.tab",row.names = FALSE, sep = "\t", quote = FALSE)
```

Filter the counts by the remaining annotations 
```{r}
# Counts 
filt_counts_annot <- filtered_Pverr.annot %>%
  left_join(DMG.all, by = "gene_id") %>%
  dplyr::select(c("gene_id", "log2FoldChange")) %>% na.omit

```
3,895 DMGs in filt_counts_annot

Make GO_MWU input csv file with fold changes 
```{r}
write.csv(filt_counts_annot, "RAnalysis/Scripts/WGBS/goMWU/DMGs_all.csv", row.names = FALSE, quote = FALSE)
```


