---
title: "DEG_DMG_pathway_analysis"
author: "daniellembecker"
date: "2023-01-20"
output: html_document
---


# Molecular Underpinnings Chronic Nutrient Enrichment Project

## Analysis of comparisons between gene ontology enrichment from differentially methylated genes and differentially expressed genes.
## Previous steps for gene expression include RNAseq workflow in Bioinformatics>RNAseq>RNAseq workflow and Differential Gene Expression statistical analysis in RAnalysis>Scripts>RNAseq_Differential_Gene_Expression to make DEG statistical data sheet
## Previous steps for DNA methylation include WGBS workflow in Bioinformatics>WGBS>WGBS workflow and Differential Methylated Genes statistical analysis in RAnalysis>Scripts>WGBS_WGBS.rmd to make DMG statistical dataframe

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load libraries

library("tidyverse")
library("RColorBrewer")
library("gridExtra")
library("ComplexHeatmap")
library("dplyr")
library("clusterProfiler")
library("pheatmap")
library("magrittr")
library("rtracklayer")
library("GenomicRanges")
library("GSEABase")
library("GOSim")
library("stats")
library("GO.db")
library("rrvgo")
```

# Import the data files 

```{r}
#upload go enrichment summary for DEGs
DEG <- read.csv("RAnalysis/Output/RNA-seq/GOSeq/GO.enrichment.summary.table.DEG.csv", header = TRUE, row.names = 1)

#rename category to GOterm
colnames(DEG)[3] ="GOterm" #rename columns

#upload go enrichment summary for DMGs
DMG <- read.csv("RAnalysis/Output/WGBS/GO.enrichment.summary.table.ontology.10x.csv", header = TRUE, row.names = 1)

#rename category to GOterm
colnames(DMG)[3] ="GOterm" #rename columns

#add column to specific type of measure
DMG <- DMG %>% add_column(type = "DMG.GO.terms")

#adjust p-values 
    DMG$bh_adjust <-  p.adjust(DMG$over_represented_pvalue, method="BH") 

```

#make Venn Diagram of overlapping GOslim terms for DMG and DEG comparison

```{r}
venn.plot <- venn.diagram(
  x = list(DEG = DEG$term, DMG = DMG$term),
  filename = 'RAnalysis/Output/meth_express_compare/venn_diagram.png',
  category.names = c('DEG GO terms', 'DMG GO terms'),
  col = "black",
	fill = c("dodgerblue", "goldenrod1"),
	cat.col = c("dodgerblue", "goldenrod1"),
)
```

#subset data sets to see alike terms
```{r}
#compare these datasets, simply pass them to the comparedf() function
#comparedf(DMG, DEG)

#Use summary() to get a more detailed summary

#summary(comparedf(DEG, DMG, by = "term"))

#these examples show unshared characteristics but don't list the actual shared terms
```

```{r}
#use dplyr inner_join instead

common <- intersect(DMG$term, DEG$term) 

common <- as.data.frame(common)

#found three common terms for DMG and DEG

#leukocyte migration involved in inflammatory response (parent term immune system response)

#positive regulation of transcription from RNA polymerase II promoter in response to heat stress (DNA-templated transcription; response to stress)

#fatty acid derivative biosynthetic process (lipid metabolic process)

#main question is why 10x terms have three overlapping but 5x does not
```

#next steps, fill in remaining parent terms for the NAs in these data sets and see the overlap there
#filter datas sets with NAs for their slim terms
```{r}
DMG.NA <- DMG %>%
  filter(is.na(slim_term))

DEG.NA <- DEG %>%
  filter(is.na(slim_term))
```






















#use rrvgo to condense to parent go terms
https://www.bioconductor.org/packages/devel/bioc/vignettes/rrvgo/inst/doc/rrvgo.html
```{r}
#Process DMG go terms
#need to load organismal database you wish to use, search databases here: http://bioconductor.org/packages/release/BiocViews.html#___OrgDb
#code: if (!require("BiocManager", quietly = TRUE)) install.packages("BiocManager") BiocManager::install("org.Ce.eg.db")


    DMG<-DMG%>%
      filter(ontology==ontology)%>%
      filter(bh_adjust != "NA") %>%
      arrange(., bh_adjust)
    
    #Reduce/collapse GO term set with the rrvgo package 
      simMatrix <- calculateSimMatrix(DMG$GOterm,
                                orgdb="org.Ce.eg.db", #c. elegans database
                                ont=category,
                                method="Rel")
    #claculate similarity 
    scores <- setNames(-log(DMG$bh_adjust), DMG$GOterm)
    reducedTerms <- reduceSimMatrix(simMatrix,
                                scores,
                                threshold=0.7,
                                orgdb="org.Ce.eg.db")
    
    
    #keep only the goterms from the reduced list
    DMG<-DMG%>%
      filter(GOterm %in% reducedTerms$go)
    
    #add in parent terms to list of go terms 
    DMG$ParentTerm<-reducedTerms$parentTerm[match(DMG$GOterm, reducedTerms$go)]
    #DMG<-DMG%>%
      #filter(grepl(paste(keywords, collapse="|"), ParentTerm))

      
    #plot significantly enriched GO terms by Slim Category faceted by slim term 
  GO.plot <-  ggplot(DMG, aes(x = ontology, y = term)) + 
    geom_point(aes(size=bh_adjust)) + 
    facet_wrap(~ pattern) +
    scale_size(name="Over rep. p-value", trans="reverse")+
    facet_grid(ParentTerm ~ ., scales = "free", space='free', labeller = label_wrap_gen(width = 8, multi_line = TRUE))+
    theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
    strip.text.y = element_text(angle=0, size = 10),
    strip.text.x = element_text(size = 20),
    axis.text = element_text(size = 8),
    axis.title.x = element_blank(),
    axis.title.y = element_blank())

ggsave("RAnalysis/Output/Final_Figures/DMG.reduced.parent.plot.png", GO.plot , width = 10, height = 30, units = c("in"))

```












