---
title: "Host RNA_seq_DESeq2"
author: "echille"
edited by: "daniellembecker"
date: "20230126"
output: html_document
---

# Molecular Underpinnings Chronic Nutrient Enrichment Project

## RNAseq Differential Expression Analysis 
## Follow RNAseq workflow in Bioinformatics>RNAseq>RNAseq workflow before statistical analysis to make gene counts and transcript counts matrices

### Set up workspace

Load libraries
```{r, message=FALSE, warning=FALSE}
library("genefilter")
library("car")
library("DESeq2")
library("factoextra")
library("MuMIn")
library("tidyverse")
library("tidyr")
library("lme4")
library("RColorBrewer")
library("magrittr")
library("ggplot2")
library("goseq")
library("pheatmap")
library("stats")
library("gridExtra")
library("VennDiagram")
library("here")
library("plotrix")
```

Import the data files 
```{r}
#treatment information
treatmentinfo <- read.csv("RAnalysis/Data/RNA-seq/metadata.RNAseq.csv", header = TRUE, sep = ",")
rownames(treatmentinfo) <- treatmentinfo$sample_id
str(treatmentinfo)
head(treatmentinfo)

#gene count matrix
gcount <- as.data.frame(read.csv("RAnalysis/Data/RNA-seq/Host/Poc_gene_count_matrix.csv"))
gcount$gene_id <-  gsub("_gene_","_",gcount$gene_id)
gcount$gene_id <-  gsub("_split_","_",gcount$gene_id)
gcount$gene_id <-  gsub("-.*","",gcount$gene_id) #remove the extra g number after the dash
row.names(gcount) <- gcount$gene_id
dim(gcount)
head(gcount)

#remove extra characters from multiple column header names for sample ids, skip first column labeled gene counts so specify 1:ncol
for ( col in 1:ncol(gcount)){
  colnames(gcount)[col] <-  sub("_R1_001.fastq.gz.sam.sorted.bam.merge.gtf", "", colnames(gcount)[col])
}

#subset the gcount matrix and reorder it so it matches the treatment info
gcount <- gcount[ ,treatmentinfo$sample_id]
head(gcount)

# Make sure treatment info ='s the rows of count data
all(rownames(treatmentinfo) %in% colnames(gcount)) # must come out TRUE

```


##### Pre-filter gene counts
## Pre-filtering our dataset to reduce the memory size dataframe, increase the speed of the transformation and testing functions, and improve quality of statistical analysis by removing low-coverage counts. Removed counts could represent outliers in the data and removing these improves sensitivity of statistical tests. We will filter out low coverage samples. Here, we will keep P=87.5% percent of the samples have counts over A=5, allowing only 1 of 8 samples to have a value less than 5 per gene.

```{r}
#Erin Set filter values for PoverA, P=87.5% percent of the samples have counts over A=5. They chose their value allowing only 1 of 8 samples to have a value less than 5 per gene. 
filt <- filterfun(pOverA(0.90,10))

#create filter for the counts data
gfilt <- genefilter(gcount, filt)

#identify genes to keep by count filter
gkeep <- gcount[gfilt,]

#identify gene lists
gn.keep <- rownames(gkeep)

#gene count data filtered in PoverA, P percent of the samples have counts over A
gcount_filt <- as.data.frame(gcount[which(rownames(gcount) %in% gn.keep),])
head(gcount_filt)
dim(gcount_filt)

```


##Merge the treatment columns into a new column , group. Set group as a factor.
```{r}
treatmentinfo$treatment <- factor(treatmentinfo$treatment, levels = c("control","enriched"))
```

#Create a DESeqDataSet design from gene count matrix and labels. Here we set the design to look at treatment to test for any differences in gene expression across timepoints attributed to treatment.
#not using DESeq due to random factors, but can still use this to visualize clusters
```{r}
#Set DESeq2 design
gdds <- DESeqDataSetFromMatrix(countData = gcount_filt,
                              colData = treatmentinfo,
                              design = ~treatment)
```

#### Visualize gene count data

We're looking to see if the samples of the same treatments cluster

##### Log-transform the count data
First we are going to log-transform the data using a variance stabilizing transforamtion (vst). This is only for visualization purposes. Essentially, this is roughly similar to putting the data on the log2 scale. It will deal with the sampling variability of low counts by calculating within-group variability (if blind=FALSE). Importantly, it does not use the design to remove variation in the data, and so can be used to examine if there may be any variability do to technical factors such as extraction batch effects.

To do this we first need to calculate the size factors of our samples. This is a rough estimate of how many reads each sample contains compared to the others. In order to use VST (the faster log2 transforming process) to log-transform our data, the size factors need to be less than 4. Otherwise, there could be artefacts in our results.
```{r}
SF.gdds <- estimateSizeFactors(gdds) #estimate size factors to determine if we can use vst  to transform our data. Size factors should be less than four to use vst
print(sizeFactors(SF.gdds)) #View size factors
```

Our size factors are all less than 4, so we can use VST!
```{r}
gvst <- vst(gdds, blind=FALSE) #apply a variance stabilizing transformation to minimize effects of small counts and normalize library size
```

#### Heatmap of sample to sample distances
```{r}
# Using vst object, plot heat-map of sample-to-sample distances
sampleDists <- dist(t(assay(gvst))) # calculate distance matrix
sampleDistMatrix <- as.matrix(sampleDists) # create distance matrix
rownames(sampleDistMatrix) <- colnames(vst) # assign row names
colnames(sampleDistMatrix) <- NULL # assign col names 
colors <- colorRampPalette(rev(brewer.pal(9, "Blues")))(255) # assign colors 
heatmap <- pheatmap(sampleDistMatrix, # plot distance matrix
         clustering_distance_rows = sampleDists, # cluster rows
         clustering_distance_cols = sampleDists, # cluster cols
         col=colors) # set colors
heatmap
pdf(file = "RAnalysis/Output/RNA-seq/DEG/Host/sampletosample_heatmap_host.pdf")
heatmap
dev.off()

```


#### Principal component plot of samples
```{r}
gPCAdata <- plotPCA(gvst, intgroup = c("treatment"), returnData=TRUE)
percentVar <- round(100*attr(gPCAdata, "percentVar")) #plot PCA of samples with all data
ggplot(gPCAdata, aes(PC1, PC2, color=treatment)) + 
  geom_point(size=3) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  ylab(paste0("PC2: ",percentVar[2],"% variance")) +
  scale_color_manual(values = c(control="black", enriched="cadetblue3")) +
  coord_fixed() +
  theme_bw() + #Set background color
  theme(panel.border = element_blank(), # Set border
        #panel.grid.major = element_blank(), #Set major gridlines
        #panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank()) #Set the plot background

ggsave(path = "RAnalysis/Output/Final_Figures/Host/", filename = "DEGSeq2_general_PCA_plot_host.pdf")

```

##### Run DE analysis for overall example 

#Run differential expression test using a Wald model. 
```{r, message = FALSE}
DEGSeq2_wald <- DESeq(gdds) # run differential expression test by treatment (?) using wald test 
# estimating size factors
# estimating dispersions
# gene-wise dispersion estimates
# mean-dispersion relationship
# final dispersion estimates
# fitting model and testing
```

#Explore significant p-values for treatment
```{r, message = FALSE}
DEGSeq2.results <- results(DEGSeq2_wald, contrast=c("treatment","control","enriched")) #run wald model
head(DEGSeq2.results)
sum(DEGSeq2.results$padj < 0.05, na.rm=TRUE) #How many adjusted p-values were less than 0.05?

#213

#### DESeq2, the function plotMA shows the log2 fold changes attributable to a given variable over the mean of normalized counts for all the samples in the DESeqDataSet.

MA_PLOT <- plotMA(DEGSeq2.results, ylim=c(-2,2))
pdf(file = "RAnalysis/Output/RNA-seq/DEG/Host/ma_plot_host.pdf")
MA_PLOT
dev.off()


#create data frame with only DESeq2 DEG's with < 0.05 significance 

DEGSeq2.sig.results <- subset(DEGSeq2.results, padj < 0.05)
DEGSeq2.sig.results <- as.data.frame(DEGSeq2.sig.results)
DEGSeq2.sig.results$gene_id <-rownames(DEGSeq2.sig.results)
write.csv(DEGSeq2.sig.results, 'RAnalysis/Output/RNA-seq/DEG/Host/DEGSeq2.sig.results.host.csv')  

```
## Identify unique genes from DEGs from treatments 
```{r}
dim(DEGSeq2.sig.results) # 213 x 7
length(unique(DEGSeq2.sig.results$gene_id)) # 213 unique genes between all treatments 
write.csv(DEGSeq2.sig.results, file = "RAnalysis/Output/RNA-seq/DEG/Host/DEGs.all_treatment_20230126_host.csv")
```

## Visualize differentially expressed genes from DESeq2
```{r}
# Subset list of genes by those which padj>0.
DEGSeq2.output <- as.data.frame(DEGSeq2.sig.results)
dim(DEGSeq2.output)
DEGSeq2.results.all <- DEGSeq2.sig.results
DEGSeq2 <- rownames(DEGSeq2.results.all) # list all gene names 
DEGSeq2 <- unique(DEGSeq2) # select only unique gene names 
DEGSeq2_list <- gdds[which(rownames(gdds) %in% DEGSeq2)] # filter gdds DESeq2 object by unique gene names
dim(DEGSeq2_list) # 15 x 15
print(counts(DEGSeq2_list))

# As determined above, size factors all less than 4, so proceed with VST
# apply a variance stabilizing transformation to minimize effects of small counts and normalize library size

DEGvst <- vst(DEGSeq2_list, blind = FALSE, nsub = nrow(counts(DEGSeq2_list)))

dim(DEGvst) # 15 x 15
print(assay(DEGvst)) # look at vst-transformed gene count data 

# Plot heat map with diff expressed genes
# Make a matrix for computing similarity
mat <- assay(DEGvst)#[DEG.results.all, ] # make an expression object
mat <- mat - rowMeans(mat) #difference in expression compared to average across all samples
dim(mat)
ann_colors <- list(treatment= c(control="black", enriched="cadetblue3"))
df_DEGSeq2 <- as.data.frame(colData(DEGvst)[c("treatment")]) #make dataframe for column naming and associated treatment
DEGSeq2_heatmap <- pheatmap(mat, scale= "row", legend=TRUE, annotation_legend=TRUE, annotation_col=df_DEGSeq2, annotation_colors = ann_colors,
                            clustering_distance_rows="euclidean", clustering_method = "average",
                            show_rownames =FALSE,
                            show_colnames =TRUE,
                            cluster_cols = TRUE)


pdf(file = "RAnalysis/Output/Final_Figures/Host/DEGSeq2_DEG_heatmap_host.pdf")
DEGSeq2_heatmap
dev.off()


# PCA plot of diff-expressed genes 
DEGSeq2_PCAdata <- plotPCA(DEGvst, intgroup = c("treatment"), returnData=TRUE)
percentVar_pca <- round(100*attr(DEGSeq2_PCAdata, "percentVar")) #plot PCA of samples with all data
DEGSeq2_PCA_plot <- ggplot(DEGSeq2_PCAdata, aes(PC1, PC2, color=treatment)) +
  geom_point(size=3) +
  xlab(paste0("PC1: ",percentVar_pca[1],"% variance")) +
  ylab(paste0("PC2: ",percentVar_pca[2],"% variance")) +
  scale_color_manual(values = c(control="black", enriched="cadetblue3")) +
  coord_fixed() +
  theme_bw() + #Set background color
  theme(panel.border = element_blank(), # Set border
        #panel.grid.major = element_blank(), #Set major gridlines
        #panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank()) #Set the plot background

DEGSeq2_PCA_plot

ggsave(path = "RAnalysis/Output/Final_Figures/Host/", filename = "DEGSeq2_DEG_PCA_plot_host.pdf")

# PCA plot is of deferentially expressed genes only

# Save results

write.csv(counts(DEGSeq2_list), file="RAnalysis/Output/RNA-seq/DEG/Host/DEGSeq2_list_unique_host.csv")

```

## DEG summary info 
## Run to calculate the DEGs, and upregulated vs. downregulated genes
```{r}
length(unique(DEGSeq2.sig.results$gene_id)) # 213 unique DEGs
down <- DEGSeq2.sig.results %>% filter(log2FoldChange < 0) 
length(unique(down$gene_id)) # 147 unique DEGs downregulated
up <- DEGSeq2.sig.results %>% filter(log2FoldChange > 0)
length(unique(up$gene_id)) # 66 unique DEGs upregulated
```







